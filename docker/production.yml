version: '3.3'
services:
    redis_db:
      image: redis:4.0-alpine
      command: redis-server --requirepass ${REDIS_PASSWORD}
      volumes:
        - ./docker-config/redis_prod.conf:/redis.conf
      command: [ "redis-server", "/redis.conf" ]
    web-server:
      image: nginx:alpine
      ports:
        - ${WEB_SERVER_PORT_HTTP}:${WEB_SERVER_PORT_HTTP}
        - ${WEB_SERVER_PORT_HTTPS}:${WEB_SERVER_PORT_HTTPS}
      volumes:
        - ./letsencrypt:/etc/letsencrypt
        - ./docker-config/nginx.conf:/etc/nginx/nginx.conf
    app:
      image: jeverd/liteboard-express:latest
      links:  # TODO verify this can be removed
        - redis_db
        - web-server
      environment:
        - NODE_ENV=${NODE_ENV}
        - EXPRESS_PORT=${EXPRESS_PORT}
        - PT_HOST=${PT_HOST}
        - PT_PORT=${PT_PORT}
        - REDIS_URL=${REDIS_URL}
        - SESSION_SECRET=${SESSION_SECRET}
        - SESSION_NAME=${SESSION_NAME}
        - SESSION_TTLE=${SESSION_TTLE}
        - LOGGER=${LOGGER}
        - EMAIL_USERNAME=${EMAIL_USERNAME}
        - EMAIL_SENDER=${EMAIL_SENDER}
        - EMAIL_PASSWORD=${EMAIL_PASSWORD}
        - EMAIL_SERVICE=${EMAIL_SERVICE}
        - JANUS_SERVER_SECRET=${JANUS_SERVER_SECRET}
        - REDIS_TURN_DB_NUMBER=${REDIS_TURN_DB_NUMBER}
        - TURN_SERVER_SECRET=${TURN_SERVER_SECRET}
        - TURN_SERVER_PORT=${TURN_SERVER_PORT}  
        - TURN_SERVER_ACTIVE=${TURN_SERVER_ACTIVE}
        - TURN_SERVER_URL=${TURN_SERVER_URL}
        - SENTRY_DSN=${SENTRY_DSN}
        - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}
        - DEFAULT_LANGUAGE=${DEFAULT_LANGUAGE}
        - DEBUG_CLIENT=${DEBUG_CLIENT}
      depends_on:
        - redis_db
        - web-server
        - janus    # might want to add some checks to ensure janus is ready, instead of just waiting for the container to be up... TODO...
      restart: always
    janus:
      image: canyan/janus-gateway:master_88df9449ac54f27afa29672cf092fac65a695c29
      command: ["/usr/local/bin/janus", "-F", "/usr/local/etc/janus"]
      links:
        - web-server
      ports:
        - "10000-10200:10000-10200/udp"
      volumes:
        - ./docker-config/janus/janus.jcfg:/usr/local/etc/janus/janus.jcfg  # might need to change this later, dk if this is best practice .... TODO
    coturn:
      image: instrumentisto/coturn
      command:
        - -c=/etc/coturn/turnserver.conf
      network_mode: "host"
      volumes:
        - ./docker-config/turnserver.conf:/etc/coturn/turnserver.conf:ro  # check if this is good to do ... BEST PRACTICE!    


